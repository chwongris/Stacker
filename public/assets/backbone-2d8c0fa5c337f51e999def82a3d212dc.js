function initMap(){var t=new google.maps.LatLng(40.7409915,-74.0098797),e={center:t,zoom:12,mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.ROADMAP,"map_style"]},zoomControl:!0,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL,position:google.maps.ControlPosition.TOP_RIGHT}},i=[{featureType:"road",elementType:"geometry",stylers:[{lightness:100},{visibility:"simplified"}]},{featureType:"road",elementType:"labels",stylers:[{visibility:"off"}]}],n=new google.maps.StyledMapType(i,{name:"Styled Map"});map=new google.maps.Map($("#map-canvas")[0],e),map.mapTypes.set("map_style",n),map.setMapTypeId("map_style")}function addMarker(t,e,i,n,s){var o=new google.maps.LatLng(t,e),r={position:o,map:map,title:i,animation:google.maps.Animation.DROP};switch(n){case"concert":r.icon="/assets/concertmarker.png";break;case"Restaurants":r.icon="/assets/restaurantmarker2.png";break;case"Bars":r.icon="/assets/barmarker.png";break;case"DanceClubs":r.icon="/assets/nightlifemarker.png"}var a=new google.maps.Marker(r),l=new google.maps.InfoWindow({content:""});l.content=s,google.maps.event.addListener(a,"click",function(){map.setZoom(18),map.setCenter(a.getPosition()),map.panBy(-220,0),l.open(map,a)}),markers.push(a),latlng.push(o)}function zoomin(t){for(var e=new google.maps.LatLngBounds,i=0;i<t.length;i++)e.extend(t[i]);map.fitBounds(e),map.panBy(-200,0)}function setAllMap(t){for(var e=0;e<markers.length;e++)markers[e].setMap(t)}function clearOverlays(){setAllMap(null)}function showOverlays(){setAllMap(map)}function deleteOverlays(){clearOverlays(),markers=[]}!function(){var rsplit=function(t,e){for(var i,n,s,o=e.exec(t),r=new Array;null!=o;)i=o.index,n=e.lastIndex,0!=i&&(s=t.substring(0,i),r.push(t.substring(0,i)),t=t.slice(i)),r.push(o[0]),t=t.slice(o[0].length),o=e.exec(t);return""==!t&&r.push(t),r},chop=function(t){return t.substr(0,t.length-1)},extend=function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])};EJS=function(t){if(t="string"==typeof t?{view:t}:t,this.set_options(t),t.precompiled)return this.template={},this.template.process=t.precompiled,EJS.update(this.name,this),void 0;if(t.element){if("string"==typeof t.element){var e=t.element;if(t.element=document.getElementById(t.element),null==t.element)throw e+"does not exist!"}this.text=t.element.value?t.element.value:t.element.innerHTML,this.name=t.element.id,this.type="["}else if(t.url){t.url=EJS.endExt(t.url,this.extMatch),this.name=this.name?this.name:t.url;var i=t.url,n=EJS.get(this.name,this.cache);if(n)return n;if(n==EJS.INVALID_PATH)return null;try{this.text=EJS.request(i+(this.cache?"":"?"+Math.random()))}catch(s){}if(null==this.text)throw{type:"EJS",message:"There is no template at "+i}}var n=new EJS.Compiler(this.text,this.type);n.compile(t,this.name),EJS.update(this.name,this),this.template=n},EJS.prototype={render:function(t,e){t=t||{},this._extra_helpers=e;var i=new EJS.Helpers(t,e||{});return this.template.process.call(t,t,i)},update:function(element,options){return"string"==typeof element&&(element=document.getElementById(element)),null==options?(_template=this,function(t){EJS.prototype.update.call(_template,element,t)}):("string"==typeof options?(params={},params.url=options,_template=this,params.onComplete=function(request){var object=eval(request.responseText);EJS.prototype.update.call(_template,element,object)},EJS.ajax_request(params)):element.innerHTML=this.render(options),void 0)},out:function(){return this.template.out},set_options:function(t){this.type=t.type||EJS.type,this.cache=null!=t.cache?t.cache:EJS.cache,this.text=t.text||null,this.name=t.name||null,this.ext=t.ext||EJS.ext,this.extMatch=new RegExp(this.ext.replace(/\./,"."))}},EJS.endExt=function(t,e){return t?(e.lastIndex=0,t+(e.test(t)?"":this.ext)):null},EJS.Scanner=function(t,e,i){extend(this,{left_delimiter:e+"%",right_delimiter:"%"+i,double_left:e+"%%",double_right:"%%"+i,left_equal:e+"%=",left_comment:e+"%#"}),this.SplitRegexp="["==e?/(\[%%)|(%%\])|(\[%=)|(\[%#)|(\[%)|(%\]\n)|(%\])|(\n)/:new RegExp("("+this.double_left+")|(%%"+this.double_right+")|("+this.left_equal+")|("+this.left_comment+")|("+this.left_delimiter+")|("+this.right_delimiter+"\n)|("+this.right_delimiter+")|(\n)"),this.source=t,this.stag=null,this.lines=0},EJS.Scanner.to_text=function(t){return null==t||void 0===t?"":t instanceof Date?t.toDateString():t.toString?t.toString():""},EJS.Scanner.prototype={scan:function(t){if(scanline=this.scanline,regex=this.SplitRegexp,""==!this.source)for(var e=rsplit(this.source,/\n/),i=0;i<e.length;i++){var n=e[i];this.scanline(n,regex,t)}},scanline:function(t,e,i){this.lines++;for(var n=rsplit(t,e),s=0;s<n.length;s++){var o=n[s];if(null!=o)try{i(o,this)}catch(r){throw{type:"EJS.Scanner",line:this.lines}}}}},EJS.Buffer=function(t,e){this.line=new Array,this.script="",this.pre_cmd=t,this.post_cmd=e;for(var i=0;i<this.pre_cmd.length;i++)this.push(t[i])},EJS.Buffer.prototype={push:function(t){this.line.push(t)},cr:function(){this.script=this.script+this.line.join("; "),this.line=new Array,this.script=this.script+"\n"},close:function(){if(this.line.length>0){for(var t=0;t<this.post_cmd.length;t++)this.push(pre_cmd[t]);this.script=this.script+this.line.join("; "),line=null}}},EJS.Compiler=function(t,e){this.pre_cmd=["var ___ViewO = [];"],this.post_cmd=new Array,this.source=" ",null!=t&&("string"==typeof t?(t=t.replace(/\r\n/g,"\n"),t=t.replace(/\r/g,"\n"),this.source=t):t.innerHTML&&(this.source=t.innerHTML),"string"!=typeof this.source&&(this.source="")),e=e||"<";var i=">";switch(e){case"[":i="]";break;case"<":break;default:throw e+" is not a supported deliminator"}this.scanner=new EJS.Scanner(this.source,e,i),this.out=""},EJS.Compiler.prototype={compile:function(options,name){options=options||{},this.out="";var put_cmd="___ViewO.push(",insert_cmd=put_cmd,buff=new EJS.Buffer(this.pre_cmd,this.post_cmd),content="",clean=function(t){return t=t.replace(/\\/g,"\\\\"),t=t.replace(/\n/g,"\\n"),t=t.replace(/"/g,'\\"')};this.scanner.scan(function(t,e){if(null==e.stag)switch(t){case"\n":content+="\n",buff.push(put_cmd+'"'+clean(content)+'");'),buff.cr(),content="";break;case e.left_delimiter:case e.left_equal:case e.left_comment:e.stag=t,content.length>0&&buff.push(put_cmd+'"'+clean(content)+'")'),content="";break;case e.double_left:content+=e.left_delimiter;break;default:content+=t}else switch(t){case e.right_delimiter:switch(e.stag){case e.left_delimiter:"\n"==content[content.length-1]?(content=chop(content),buff.push(content),buff.cr()):buff.push(content);break;case e.left_equal:buff.push(insert_cmd+"(EJS.Scanner.to_text("+content+")))")}e.stag=null,content="";break;case e.double_right:content+=e.right_delimiter;break;default:content+=t}}),content.length>0&&buff.push(put_cmd+'"'+clean(content)+'")'),buff.close(),this.out=buff.script+";";var to_be_evaled="/*"+name+"*/this.process = function(_CONTEXT,_VIEW) { try { with(_VIEW) { with (_CONTEXT) {"+this.out+" return ___ViewO.join('');}}}catch(e){e.lineNumber=null;throw e;}};";try{eval(to_be_evaled)}catch(e){if("undefined"==typeof JSLINT)throw e;JSLINT(this.out);for(var i=0;i<JSLINT.errors.length;i++){var error=JSLINT.errors[i];if("Unnecessary semicolon."!=error.reason){error.line++;var e=new Error;throw e.lineNumber=error.line,e.message=error.reason,options.view&&(e.fileName=options.view),e}}}}},EJS.config=function(t){EJS.cache=null!=t.cache?t.cache:EJS.cache,EJS.type=null!=t.type?t.type:EJS.type,EJS.ext=null!=t.ext?t.ext:EJS.ext;var e=EJS.templates_directory||{};EJS.templates_directory=e,EJS.get=function(t,i){return 0==i?null:e[t]?e[t]:null},EJS.update=function(t,i){null!=t&&(e[t]=i)},EJS.INVALID_PATH=-1},EJS.config({cache:!0,type:"<",ext:".ejs"}),EJS.Helpers=function(t,e){this._data=t,this._extras=e,extend(this,e)},EJS.Helpers.prototype={view:function(t,e,i){return i||(i=this._extras),e||(e=this._data),new EJS(t).render(e,i)},to_text:function(t,e){return null==t||void 0===t?e||"":t instanceof Date?t.toDateString():t.toString?t.toString().replace(/\n/g,"<br />").replace(/''/g,"'"):""}},EJS.newRequest=function(){for(var t=[function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new XMLHttpRequest},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],e=0;e<t.length;e++)try{var i=t[e]();if(null!=i)return i}catch(n){continue}},EJS.request=function(t){var e=new EJS.newRequest;e.open("GET",t,!1);try{e.send(null)}catch(i){return null}return 404==e.status||2==e.status||0==e.status&&""==e.responseText?null:e.responseText},EJS.ajax_request=function(t){t.method=t.method?t.method:"GET";var e=new EJS.newRequest;e.onreadystatechange=function(){4==e.readyState&&(200==e.status?t.onComplete(e):t.onComplete(e))},e.open(t.method,t.url),e.send(null)}}(),EJS.Helpers.prototype.date_tag=function(t,e){e instanceof Date||(e=new Date);for(var i=["January","February","March","April","May","June","July","August","September","October","November","December"],n=[],s=[],o=[],r=e.getFullYear(),a=e.getMonth(),l=e.getDate(),c=r-15;r+15>c;c++)n.push({value:c,text:c});for(var h=0;12>h;h++)s.push({value:h,text:i[h]});for(var u=0;31>u;u++)o.push({value:u+1,text:u+1});var d=this.select_tag(t+"[year]",r,n,{id:t+"[year]"}),p=this.select_tag(t+"[month]",a,s,{id:t+"[month]"}),f=this.select_tag(t+"[day]",l,o,{id:t+"[day]"});return d+p+f},EJS.Helpers.prototype.form_tag=function(t,e){return e=e||{},e.action=t,1==e.multipart&&(e.method="post",e.enctype="multipart/form-data"),this.start_tag_for("form",e)},EJS.Helpers.prototype.form_tag_end=function(){return this.tag_end("form")},EJS.Helpers.prototype.hidden_field_tag=function(t,e,i){return this.input_field_tag(t,e,"hidden",i)},EJS.Helpers.prototype.input_field_tag=function(t,e,i,n){return n=n||{},n.id=n.id||t,n.value=e||"",n.type=i||"text",n.name=t,this.single_tag_for("input",n)},EJS.Helpers.prototype.is_current_page=function(t){return window.location.href==t||window.location.pathname==t?!0:!1},EJS.Helpers.prototype.link_to=function(t,e,i){if(!t)var t="null";if(!i)var i={};return i.confirm&&(i.onclick=' var ret_confirm = confirm("'+i.confirm+'"); if(!ret_confirm){ return false;} ',i.confirm=null),i.href=e,this.start_tag_for("a",i)+t+this.tag_end("a")},EJS.Helpers.prototype.submit_link_to=function(t,e,i){if(!t)var t="null";if(!i)var i={};return i.onclick=i.onclick||"",i.confirm&&(i.onclick=' var ret_confirm = confirm("'+i.confirm+'"); if(!ret_confirm){ return false;} ',i.confirm=null),i.value=t,i.type="submit",i.onclick=i.onclick+(e?this.url_for(e):"")+"return false;",this.start_tag_for("input",i)},EJS.Helpers.prototype.link_to_if=function(t,e,i,n,s,o){return this.link_to_unless(0==t,e,i,n,s,o)},EJS.Helpers.prototype.link_to_unless=function(t,e,i,n,s){return n=n||{},t?s&&"function"==typeof s?s(e,i,n,s):e:this.link_to(e,i,n)},EJS.Helpers.prototype.link_to_unless_current=function(t,e,i,n){return i=i||{},this.link_to_unless(this.is_current_page(e),t,e,i,n)},EJS.Helpers.prototype.password_field_tag=function(t,e,i){return this.input_field_tag(t,e,"password",i)},EJS.Helpers.prototype.select_tag=function(t,e,i,n){n=n||{},n.id=n.id||t,n.value=e,n.name=t;var s="";s+=this.start_tag_for("select",n);for(var o=0;o<i.length;o++){var r=i[o],a={value:r.value};r.value==e&&(a.selected="selected"),s+=this.start_tag_for("option",a)+r.text+this.tag_end("option")}return s+=this.tag_end("select")},EJS.Helpers.prototype.single_tag_for=function(t,e){return this.tag(t,e,"/>")},EJS.Helpers.prototype.start_tag_for=function(t,e){return this.tag(t,e)},EJS.Helpers.prototype.submit_tag=function(t,e){return e=e||{},e.type=e.type||"submit",e.value=t||"Submit",this.single_tag_for("input",e)},EJS.Helpers.prototype.tag=function(t,e,i){if(!i)var i=">";var n=" ";for(var s in e){if(null!=e[s])var o=e[s].toString();else var o="";"Class"==s&&(s="class"),n+=-1!=o.indexOf("'")?s+'="'+o+'" ':s+"='"+o+"' "}return"<"+t+n+i},EJS.Helpers.prototype.tag_end=function(t){return"</"+t+">"},EJS.Helpers.prototype.text_area_tag=function(t,e,i){return i=i||{},i.id=i.id||t,i.name=i.name||t,e=e||"",i.size&&(i.cols=i.size.split("x")[0],i.rows=i.size.split("x")[1],delete i.size),i.cols=i.cols||50,i.rows=i.rows||4,this.start_tag_for("textarea",i)+e+this.tag_end("textarea")},EJS.Helpers.prototype.text_tag=EJS.Helpers.prototype.text_area_tag,EJS.Helpers.prototype.text_field_tag=function(t,e,i){return this.input_field_tag(t,e,"text",i)},EJS.Helpers.prototype.url_for=function(t){return'window.location="'+t+'";'},EJS.Helpers.prototype.img_tag=function(t,e,i){return i=i||{},i.src=t,i.alt=e,this.single_tag_for("img",i)},function(){var t,e=this,i=e.Backbone,n=[],s=n.push,o=n.slice,r=n.splice;t="undefined"!=typeof exports?exports:e.Backbone={},t.VERSION="1.0.0";var a=e._;a||"undefined"==typeof require||(a=require("underscore")),t.$=e.jQuery||e.Zepto||e.ender||e.$,t.noConflict=function(){return e.Backbone=i,this},t.emulateHTTP=!1,t.emulateJSON=!1;var l=t.Events={on:function(t,e,i){if(!h(this,"on",t,[e,i])||!e)return this;this._events||(this._events={});var n=this._events[t]||(this._events[t]=[]);return n.push({callback:e,context:i,ctx:i||this}),this},once:function(t,e,i){if(!h(this,"once",t,[e,i])||!e)return this;var n=this,s=a.once(function(){n.off(t,s),e.apply(this,arguments)});return s._callback=e,this.on(t,s,i)},off:function(t,e,i){var n,s,o,r,l,c,u,d;if(!this._events||!h(this,"off",t,[e,i]))return this;if(!t&&!e&&!i)return this._events={},this;for(r=t?[t]:a.keys(this._events),l=0,c=r.length;c>l;l++)if(t=r[l],o=this._events[t]){if(this._events[t]=n=[],e||i)for(u=0,d=o.length;d>u;u++)s=o[u],(e&&e!==s.callback&&e!==s.callback._callback||i&&i!==s.context)&&n.push(s);n.length||delete this._events[t]}return this},trigger:function(t){if(!this._events)return this;var e=o.call(arguments,1);if(!h(this,"trigger",t,e))return this;var i=this._events[t],n=this._events.all;return i&&u(i,e),n&&u(n,arguments),this},stopListening:function(t,e,i){var n=this._listeners;if(!n)return this;var s=!e&&!i;"object"==typeof e&&(i=this),t&&((n={})[t._listenerId]=t);for(var o in n)n[o].off(e,i,this),s&&delete this._listeners[o];return this}},c=/\s+/,h=function(t,e,i,n){if(!i)return!0;if("object"==typeof i){for(var s in i)t[e].apply(t,[s,i[s]].concat(n));return!1}if(c.test(i)){for(var o=i.split(c),r=0,a=o.length;a>r;r++)t[e].apply(t,[o[r]].concat(n));return!1}return!0},u=function(t,e){var i,n=-1,s=t.length,o=e[0],r=e[1],a=e[2];switch(e.length){case 0:for(;++n<s;)(i=t[n]).callback.call(i.ctx);return;case 1:for(;++n<s;)(i=t[n]).callback.call(i.ctx,o);return;case 2:for(;++n<s;)(i=t[n]).callback.call(i.ctx,o,r);return;case 3:for(;++n<s;)(i=t[n]).callback.call(i.ctx,o,r,a);return;default:for(;++n<s;)(i=t[n]).callback.apply(i.ctx,e)}},d={listenTo:"on",listenToOnce:"once"};a.each(d,function(t,e){l[e]=function(e,i,n){var s=this._listeners||(this._listeners={}),o=e._listenerId||(e._listenerId=a.uniqueId("l"));return s[o]=e,"object"==typeof i&&(n=this),e[t](i,n,this),this}}),l.bind=l.on,l.unbind=l.off,a.extend(t,l);var p=t.Model=function(t,e){var i,n=t||{};e||(e={}),this.cid=a.uniqueId("c"),this.attributes={},a.extend(this,a.pick(e,f)),e.parse&&(n=this.parse(n,e)||{}),(i=a.result(this,"defaults"))&&(n=a.defaults({},n,i)),this.set(n,e),this.changed={},this.initialize.apply(this,arguments)},f=["url","urlRoot","collection"];a.extend(p.prototype,l,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(){return a.clone(this.attributes)},sync:function(){return t.sync.apply(this,arguments)},get:function(t){return this.attributes[t]},escape:function(t){return a.escape(this.get(t))},has:function(t){return null!=this.get(t)},set:function(t,e,i){var n,s,o,r,l,c,h,u;if(null==t)return this;if("object"==typeof t?(s=t,i=e):(s={})[t]=e,i||(i={}),!this._validate(s,i))return!1;o=i.unset,l=i.silent,r=[],c=this._changing,this._changing=!0,c||(this._previousAttributes=a.clone(this.attributes),this.changed={}),u=this.attributes,h=this._previousAttributes,this.idAttribute in s&&(this.id=s[this.idAttribute]);for(n in s)e=s[n],a.isEqual(u[n],e)||r.push(n),a.isEqual(h[n],e)?delete this.changed[n]:this.changed[n]=e,o?delete u[n]:u[n]=e;if(!l){r.length&&(this._pending=!0);for(var d=0,p=r.length;p>d;d++)this.trigger("change:"+r[d],this,u[r[d]],i)}if(c)return this;if(!l)for(;this._pending;)this._pending=!1,this.trigger("change",this,i);return this._pending=!1,this._changing=!1,this},unset:function(t,e){return this.set(t,void 0,a.extend({},e,{unset:!0}))},clear:function(t){var e={};for(var i in this.attributes)e[i]=void 0;return this.set(e,a.extend({},t,{unset:!0}))},hasChanged:function(t){return null==t?!a.isEmpty(this.changed):a.has(this.changed,t)},changedAttributes:function(t){if(!t)return this.hasChanged()?a.clone(this.changed):!1;var e,i=!1,n=this._changing?this._previousAttributes:this.attributes;for(var s in t)a.isEqual(n[s],e=t[s])||((i||(i={}))[s]=e);return i},previous:function(t){return null!=t&&this._previousAttributes?this._previousAttributes[t]:null},previousAttributes:function(){return a.clone(this._previousAttributes)},fetch:function(t){t=t?a.clone(t):{},void 0===t.parse&&(t.parse=!0);var e=this,i=t.success;return t.success=function(n){return e.set(e.parse(n,t),t)?(i&&i(e,n,t),e.trigger("sync",e,n,t),void 0):!1},N(this,t),this.sync("read",this,t)},save:function(t,e,i){var n,s,o,r=this.attributes;if(null==t||"object"==typeof t?(n=t,i=e):(n={})[t]=e,!(!n||i&&i.wait||this.set(n,i)))return!1;if(i=a.extend({validate:!0},i),!this._validate(n,i))return!1;n&&i.wait&&(this.attributes=a.extend({},r,n)),void 0===i.parse&&(i.parse=!0);var l=this,c=i.success;return i.success=function(t){l.attributes=r;var e=l.parse(t,i);return i.wait&&(e=a.extend(n||{},e)),a.isObject(e)&&!l.set(e,i)?!1:(c&&c(l,t,i),l.trigger("sync",l,t,i),void 0)},N(this,i),s=this.isNew()?"create":i.patch?"patch":"update","patch"===s&&(i.attrs=n),o=this.sync(s,this,i),n&&i.wait&&(this.attributes=r),o},destroy:function(t){t=t?a.clone(t):{};var e=this,i=t.success,n=function(){e.trigger("destroy",e,e.collection,t)};if(t.success=function(s){(t.wait||e.isNew())&&n(),i&&i(e,s,t),e.isNew()||e.trigger("sync",e,s,t)},this.isNew())return t.success(),!1;N(this,t);var s=this.sync("delete",this,t);return t.wait||n(),s},url:function(){var t=a.result(this,"urlRoot")||a.result(this.collection,"url")||L();return this.isNew()?t:t+("/"===t.charAt(t.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(t){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},isValid:function(t){return this._validate({},a.extend(t||{},{validate:!0}))},_validate:function(t,e){if(!e.validate||!this.validate)return!0;t=a.extend({},this.attributes,t);var i=this.validationError=this.validate(t,e)||null;return i?(this.trigger("invalid",this,i,a.extend(e||{},{validationError:i})),!1):!0}});var m=["keys","values","pairs","invert","pick","omit"];a.each(m,function(t){p.prototype[t]=function(){var e=o.call(arguments);return e.unshift(this.attributes),a[t].apply(a,e)}});var v=t.Collection=function(t,e){e||(e={}),e.url&&(this.url=e.url),e.model&&(this.model=e.model),void 0!==e.comparator&&(this.comparator=e.comparator),this._reset(),this.initialize.apply(this,arguments),t&&this.reset(t,a.extend({silent:!0},e))},g={add:!0,remove:!0,merge:!0},y={add:!0,merge:!1,remove:!1};a.extend(v.prototype,l,{model:p,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return t.sync.apply(this,arguments)},add:function(t,e){return this.set(t,a.defaults(e||{},y))},remove:function(t,e){t=a.isArray(t)?t.slice():[t],e||(e={});var i,n,s,o;for(i=0,n=t.length;n>i;i++)o=this.get(t[i]),o&&(delete this._byId[o.id],delete this._byId[o.cid],s=this.indexOf(o),this.models.splice(s,1),this.length--,e.silent||(e.index=s,o.trigger("remove",o,this,e)),this._removeReference(o));return this},set:function(t,e){e=a.defaults(e||{},g),e.parse&&(t=this.parse(t,e)),a.isArray(t)||(t=t?[t]:[]);var i,n,o,l,c,h=e.at,u=this.comparator&&null==h&&e.sort!==!1,d=a.isString(this.comparator)?this.comparator:null,p=[],f=[],m={};for(i=0,n=t.length;n>i;i++)(o=this._prepareModel(t[i],e))&&((l=this.get(o))?(e.remove&&(m[l.cid]=!0),e.merge&&(l.set(o.attributes,e),u&&!c&&l.hasChanged(d)&&(c=!0))):e.add&&(p.push(o),o.on("all",this._onModelEvent,this),this._byId[o.cid]=o,null!=o.id&&(this._byId[o.id]=o)));if(e.remove){for(i=0,n=this.length;n>i;++i)m[(o=this.models[i]).cid]||f.push(o);f.length&&this.remove(f,e)}if(p.length&&(u&&(c=!0),this.length+=p.length,null!=h?r.apply(this.models,[h,0].concat(p)):s.apply(this.models,p)),c&&this.sort({silent:!0}),e.silent)return this;for(i=0,n=p.length;n>i;i++)(o=p[i]).trigger("add",o,this,e);return c&&this.trigger("sort",this,e),this},reset:function(t,e){e||(e={});for(var i=0,n=this.models.length;n>i;i++)this._removeReference(this.models[i]);return e.previousModels=this.models,this._reset(),this.add(t,a.extend({silent:!0},e)),e.silent||this.trigger("reset",this,e),this},push:function(t,e){return t=this._prepareModel(t,e),this.add(t,a.extend({at:this.length},e)),t},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t),e},unshift:function(t,e){return t=this._prepareModel(t,e),this.add(t,a.extend({at:0},e)),t},shift:function(t){var e=this.at(0);return this.remove(e,t),e},slice:function(t,e){return this.models.slice(t,e)},get:function(t){return null==t?void 0:this._byId[null!=t.id?t.id:t.cid||t]},at:function(t){return this.models[t]},where:function(t,e){return a.isEmpty(t)?e?void 0:[]:this[e?"find":"filter"](function(e){for(var i in t)if(t[i]!==e.get(i))return!1;return!0})},findWhere:function(t){return this.where(t,!0)},sort:function(t){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return t||(t={}),a.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(a.bind(this.comparator,this)),t.silent||this.trigger("sort",this,t),this},sortedIndex:function(t,e,i){e||(e=this.comparator);var n=a.isFunction(e)?e:function(t){return t.get(e)};return a.sortedIndex(this.models,t,n,i)},pluck:function(t){return a.invoke(this.models,"get",t)},fetch:function(t){t=t?a.clone(t):{},void 0===t.parse&&(t.parse=!0);var e=t.success,i=this;return t.success=function(n){var s=t.reset?"reset":"set";i[s](n,t),e&&e(i,n,t),i.trigger("sync",i,n,t)},N(this,t),this.sync("read",this,t)},create:function(t,e){if(e=e?a.clone(e):{},!(t=this._prepareModel(t,e)))return!1;e.wait||this.add(t,e);var i=this,n=e.success;return e.success=function(s){e.wait&&i.add(t,e),n&&n(t,s,e)},t.save(null,e),t},parse:function(t){return t},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(t,e){if(t instanceof p)return t.collection||(t.collection=this),t;e||(e={}),e.collection=this;var i=new this.model(t,e);return i._validate(t,e)?i:(this.trigger("invalid",this,t,e),!1)},_removeReference:function(t){this===t.collection&&delete t.collection,t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,i,n){("add"!==t&&"remove"!==t||i===this)&&("destroy"===t&&this.remove(e,n),e&&t==="change:"+e.idAttribute&&(delete this._byId[e.previous(e.idAttribute)],null!=e.id&&(this._byId[e.id]=e)),this.trigger.apply(this,arguments))}});var _=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];a.each(_,function(t){v.prototype[t]=function(){var e=o.call(arguments);return e.unshift(this.models),a[t].apply(a,e)}});var b=["groupBy","countBy","sortBy"];a.each(b,function(t){v.prototype[t]=function(e,i){var n=a.isFunction(e)?e:function(t){return t.get(e)};return a[t](this.models,n,i)}});var w=t.View=function(t){this.cid=a.uniqueId("view"),this._configure(t||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},k=/^(\S+)\s*(.*)$/,R=["model","collection","el","id","attributes","className","tagName","events"];a.extend(w.prototype,l,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(e,i){return this.$el&&this.undelegateEvents(),this.$el=e instanceof t.$?e:t.$(e),this.el=this.$el[0],i!==!1&&this.delegateEvents(),this},delegateEvents:function(t){if(!t&&!(t=a.result(this,"events")))return this;this.undelegateEvents();for(var e in t){var i=t[e];if(a.isFunction(i)||(i=this[t[e]]),i){var n=e.match(k),s=n[1],o=n[2];i=a.bind(i,this),s+=".delegateEvents"+this.cid,""===o?this.$el.on(s,i):this.$el.on(s,o,i)}}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_configure:function(t){this.options&&(t=a.extend({},a.result(this,"options"),t)),a.extend(this,a.pick(t,R)),this.options=t},_ensureElement:function(){if(this.el)this.setElement(a.result(this,"el"),!1);else{var e=a.extend({},a.result(this,"attributes"));this.id&&(e.id=a.result(this,"id")),this.className&&(e["class"]=a.result(this,"className"));var i=t.$("<"+a.result(this,"tagName")+">").attr(e);this.setElement(i,!1)}}}),t.sync=function(e,i,n){var s=S[e];a.defaults(n||(n={}),{emulateHTTP:t.emulateHTTP,emulateJSON:t.emulateJSON});var o={type:s,dataType:"json"};if(n.url||(o.url=a.result(i,"url")||L()),null!=n.data||!i||"create"!==e&&"update"!==e&&"patch"!==e||(o.contentType="application/json",o.data=JSON.stringify(n.attrs||i.toJSON(n))),n.emulateJSON&&(o.contentType="application/x-www-form-urlencoded",o.data=o.data?{model:o.data}:{}),n.emulateHTTP&&("PUT"===s||"DELETE"===s||"PATCH"===s)){o.type="POST",n.emulateJSON&&(o.data._method=s);var r=n.beforeSend;n.beforeSend=function(t){return t.setRequestHeader("X-HTTP-Method-Override",s),r?r.apply(this,arguments):void 0}}"GET"===o.type||n.emulateJSON||(o.processData=!1),"PATCH"!==o.type||!window.ActiveXObject||window.external&&window.external.msActiveXFilteringEnabled||(o.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var l=n.xhr=t.ajax(a.extend(o,n));return i.trigger("request",i,l,n),l};var S={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};t.ajax=function(){return t.$.ajax.apply(t.$,arguments)};var M=t.Router=function(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},T=/\((.*?)\)/g,x=/(\(\?)?:\w+/g,E=/\*\w+/g,C=/[\-{}\[\]+?.,\\\^$|#\s]/g;a.extend(M.prototype,l,{initialize:function(){},route:function(e,i,n){a.isRegExp(e)||(e=this._routeToRegExp(e)),a.isFunction(i)&&(n=i,i=""),n||(n=this[i]);var s=this;return t.history.route(e,function(o){var r=s._extractParameters(e,o);n&&n.apply(s,r),s.trigger.apply(s,["route:"+i].concat(r)),s.trigger("route",i,r),t.history.trigger("route",s,i,r)}),this},navigate:function(e,i){return t.history.navigate(e,i),this},_bindRoutes:function(){if(this.routes){this.routes=a.result(this,"routes");for(var t,e=a.keys(this.routes);null!=(t=e.pop());)this.route(t,this.routes[t])}},_routeToRegExp:function(t){return t=t.replace(C,"\\$&").replace(T,"(?:$1)?").replace(x,function(t,e){return e?t:"([^/]+)"}).replace(E,"(.*?)"),new RegExp("^"+t+"$")},_extractParameters:function(t,e){var i=t.exec(e).slice(1);return a.map(i,function(t){return t?decodeURIComponent(t):null})}});var J=t.History=function(){this.handlers=[],a.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},A=/^[#\/]|\s+$/g,H=/^\/+|\/+$/g,$=/msie [\w.]+/,O=/\/$/;J.started=!1,a.extend(J.prototype,l,{interval:50,getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getFragment:function(t,e){if(null==t)if(this._hasPushState||!this._wantsHashChange||e){t=this.location.pathname;var i=this.root.replace(O,"");t.indexOf(i)||(t=t.substr(i.length))}else t=this.getHash();return t.replace(A,"")},start:function(e){if(J.started)throw new Error("Backbone.history has already been started");J.started=!0,this.options=a.extend({},{root:"/"},this.options,e),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var i=this.getFragment(),n=document.documentMode,s=$.exec(navigator.userAgent.toLowerCase())&&(!n||7>=n);this.root=("/"+this.root+"/").replace(H,"/"),s&&this._wantsHashChange&&(this.iframe=t.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(i)),this._hasPushState?t.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!s?t.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=i;var o=this.location,r=o.pathname.replace(/[^\/]$/,"$&/")===this.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!r?(this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&r&&o.hash&&(this.fragment=this.getHash().replace(A,""),this.history.replaceState({},document.title,this.root+this.fragment+o.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){t.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),J.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(){var t=this.getFragment();return t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe))),t===this.fragment?!1:(this.iframe&&this.navigate(t),this.loadUrl()||this.loadUrl(this.getHash()),void 0)},loadUrl:function(t){var e=this.fragment=this.getFragment(t),i=a.any(this.handlers,function(t){return t.route.test(e)?(t.callback(e),!0):void 0});return i},navigate:function(t,e){if(!J.started)return!1;if(e&&e!==!0||(e={trigger:e}),t=this.getFragment(t||""),this.fragment!==t){this.fragment=t;var i=this.root+t;if(this._hasPushState)this.history[e.replace?"replaceState":"pushState"]({},document.title,i);else{if(!this._wantsHashChange)return this.location.assign(i);this._updateHash(this.location,t,e.replace),this.iframe&&t!==this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,t,e.replace))}e.trigger&&this.loadUrl(t)}},_updateHash:function(t,e,i){if(i){var n=t.href.replace(/(javascript:|#).*$/,"");t.replace(n+"#"+e)}else t.hash="#"+e}}),t.history=new J;var I=function(t,e){var i,n=this;i=t&&a.has(t,"constructor")?t.constructor:function(){return n.apply(this,arguments)},a.extend(i,n,e);var s=function(){this.constructor=i};return s.prototype=n.prototype,i.prototype=new s,t&&a.extend(i.prototype,t),i.__super__=n.prototype,i};p.extend=v.extend=M.extend=w.extend=J.extend=I;var L=function(){throw new Error('A "url" property or function must be specified')},N=function(t,e){var i=e.error;e.error=function(n){i&&i(t,n,e),t.trigger("error",t,n,e)}}}.call(this),function(t){"use strict";var e,i,n;"undefined"==typeof window?(e=require("underscore"),i=require("backbone"),n=module.exports=i):(e=window._,i=window.Backbone,n=window),i.Relational={showWarnings:!0},i.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable)throw new Error("Max permits acquired");this._permitsUsed++},release:function(){if(0===this._permitsUsed)throw new Error("All permits released");this._permitsUsed--},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(t){if(this._permitsUsed>t)throw new Error("Available permits cannot be less than used permits");this._permitsAvailable=t}},i.BlockingQueue=function(){this._queue=[]},e.extend(i.BlockingQueue.prototype,i.Semaphore,{_queue:null,add:function(t){this.isBlocked()?this._queue.push(t):t()},process:function(){for(;this._queue&&this._queue.length;)this._queue.shift()()},block:function(){this.acquire()},unblock:function(){this.release(),this.isBlocked()||this.process()},isBlocked:function(){return this.isLocked()}}),i.Relational.eventQueue=new i.BlockingQueue,i.Store=function(){this._collections=[],this._reverseRelations=[],this._orphanRelations=[],this._subModels=[],this._modelScopes=[n]},e.extend(i.Store.prototype,i.Events,{initializeRelation:function(t,n,s){var o=e.isString(n.type)?i[n.type]||this.getObjectByName(n.type):n.type;o&&o.prototype instanceof i.Relation?new o(t,n,s):i.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; missing or invalid relation type!",n)
},addModelScope:function(t){this._modelScopes.push(t)},removeModelScope:function(t){this._modelScopes=e.without(this._modelScopes,t)},addSubModels:function(t,e){this._subModels.push({superModelType:e,subModels:t})},setupSuperModel:function(t){e.find(this._subModels,function(i){return e.find(i.subModels||[],function(e,n){var s=this.getObjectByName(e);return t===s?(i.superModelType._subModels[n]=t,t._superModel=i.superModelType,t._subModelTypeValue=n,t._subModelTypeAttribute=i.superModelType.prototype.subModelTypeAttribute,!0):void 0},this)},this)},addReverseRelation:function(t){var i=e.any(this._reverseRelations,function(i){return e.all(t||[],function(t,e){return t===i[e]})});!i&&t.model&&t.type&&(this._reverseRelations.push(t),this._addRelation(t.model,t),this.retroFitRelation(t))},addOrphanRelation:function(t){var i=e.any(this._orphanRelations,function(i){return e.all(t||[],function(t,e){return t===i[e]})});!i&&t.model&&t.type&&this._orphanRelations.push(t)},processOrphanRelations:function(){e.each(this._orphanRelations.slice(0),function(t){var n=i.Relational.store.getObjectByName(t.relatedModel);n&&(this.initializeRelation(null,t),this._orphanRelations=e.without(this._orphanRelations,t))},this)},_addRelation:function(t,i){t.prototype.relations||(t.prototype.relations=[]),t.prototype.relations.push(i),e.each(t._subModels||[],function(t){this._addRelation(t,i)},this)},retroFitRelation:function(t){var e=this.getCollection(t.model,!1);e&&e.each(function(e){e instanceof t.model&&new t.type(e,t)},this)},getCollection:function(t,n){t instanceof i.RelationalModel&&(t=t.constructor);for(var s=t;s._superModel;)s=s._superModel;var o=e.findWhere(this._collections,{model:s});return o||n===!1||(o=this._createCollection(s)),o},getObjectByName:function(i){var n=i.split("."),s=null;return e.find(this._modelScopes,function(i){return s=e.reduce(n||[],function(e,i){return e?e[i]:t},i),s&&s!==i?!0:void 0},this),s},_createCollection:function(t){var e;return t instanceof i.RelationalModel&&(t=t.constructor),t.prototype instanceof i.RelationalModel&&(e=new i.Collection,e.model=t,this._collections.push(e)),e},resolveIdForItem:function(t,n){var s=e.isString(n)||e.isNumber(n)?n:null;return null===s&&(n instanceof i.RelationalModel?s=n.id:e.isObject(n)&&(s=n[t.prototype.idAttribute])),s||0===s||(s=null),s},find:function(t,e){var i=this.resolveIdForItem(t,e),n=this.getCollection(t);if(n){var s=n.get(i);if(s instanceof t)return s}return null},register:function(t){var e=this.getCollection(t);if(e){var i=t.collection;e.add(t),this.listenTo(t,"destroy",this.unregister,this),t.collection=i}},checkId:function(t,e){var n=this.getCollection(t),s=n&&n.get(e);if(s&&t!==s)throw i.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Duplicate id! Old RelationalModel=%o, new RelationalModel=%o",s,t),new Error("Cannot instantiate more than one Backbone.RelationalModel with the same id per type!")},update:function(t){var e=this.getCollection(t);e._onModelEvent("change:"+t.idAttribute,t,e),t.trigger("relational:change:id",t,e)},unregister:function(t){this.stopListening(t,"destroy",this.unregister);var e=this.getCollection(t);e&&e.remove(t)},reset:function(){this.stopListening(),this._collections=[],this._subModels=[],this._modelScopes=[n]}}),i.Relational.store=new i.Store,i.Relation=function(t,n,s){if(this.instance=t,n=e.isObject(n)?n:{},this.reverseRelation=e.defaults(n.reverseRelation||{},this.options.reverseRelation),this.options=e.defaults(n,this.options,i.Relation.prototype.options),this.reverseRelation.type=e.isString(this.reverseRelation.type)?i[this.reverseRelation.type]||i.Relational.store.getObjectByName(this.reverseRelation.type):this.reverseRelation.type,this.key=this.options.key,this.keySource=this.options.keySource||this.key,this.keyDestination=this.options.keyDestination||this.keySource||this.key,this.model=this.options.model||this.instance.constructor,this.relatedModel=this.options.relatedModel,e.isString(this.relatedModel)&&(this.relatedModel=i.Relational.store.getObjectByName(this.relatedModel)),this.checkPreconditions()&&(!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key&&i.Relational.store.addReverseRelation(e.defaults({isAutoRelation:!0,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation)),t)){var o=this.keySource;o!==this.key&&"object"==typeof this.instance.get(this.key)&&(o=this.key),this.setKeyContents(this.instance.get(o)),this.relatedCollection=i.Relational.store.getCollection(this.relatedModel),this.keySource!==this.key&&this.instance.unset(this.keySource,{silent:!0}),this.instance._relations[this.key]=this,this.initialize(s),this.options.autoFetch&&this.instance.fetchRelated(this.key,e.isObject(this.options.autoFetch)?this.options.autoFetch:{}),this.listenTo(this.instance,"destroy",this.destroy).listenTo(this.relatedCollection,"relational:add relational:change:id",this.tryAddRelated).listenTo(this.relatedCollection,"relational:remove",this.removeRelated)}},i.Relation.extend=i.Model.extend,e.extend(i.Relation.prototype,i.Events,i.Semaphore,{options:{createModels:!0,includeInJSON:!0,isAutoRelation:!1,autoFetch:!1,parse:!1},instance:null,key:null,keyContents:null,relatedModel:null,relatedCollection:null,reverseRelation:null,related:null,checkPreconditions:function(){var t=this.instance,n=this.key,s=this.model,o=this.relatedModel,r=i.Relational.showWarnings&&"undefined"!=typeof console;if(!s||!n||!o)return r&&console.warn("Relation=%o: missing model, key or relatedModel (%o, %o, %o).",this,s,n,o),!1;if(!(s.prototype instanceof i.RelationalModel))return r&&console.warn("Relation=%o: model does not inherit from Backbone.RelationalModel (%o).",this,t),!1;if(!(o.prototype instanceof i.RelationalModel))return r&&console.warn("Relation=%o: relatedModel does not inherit from Backbone.RelationalModel (%o).",this,o),!1;if(this instanceof i.HasMany&&this.reverseRelation.type===i.HasMany)return r&&console.warn("Relation=%o: relation is a HasMany, and the reverseRelation is HasMany as well.",this),!1;if(t&&e.keys(t._relations).length){var a=e.find(t._relations,function(t){return t.key===n},this);if(a)return r&&console.warn("Cannot create relation=%o on %o for model=%o: already taken by relation=%o.",this,n,t,a),!1}return!0},setRelated:function(t){this.related=t,this.instance.acquire(),this.instance.attributes[this.key]=t,this.instance.release()},_isReverseRelation:function(t){return t.instance instanceof this.relatedModel&&this.reverseRelation.key===t.key&&this.key===t.reverseRelation.key},getReverseRelations:function(t){var i=[],n=e.isUndefined(t)?this.related&&(this.related.models||[this.related]):[t];return e.each(n||[],function(t){e.each(t.getRelations()||[],function(t){this._isReverseRelation(t)&&i.push(t)},this)},this),i},destroy:function(){this.stopListening(),this instanceof i.HasOne?this.setRelated(null):this instanceof i.HasMany&&this.setRelated(this._prepareCollection()),e.each(this.getReverseRelations(),function(t){t.removeRelated(this.instance)},this)}}),i.HasOne=i.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(t){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);var i=this.findRelated(t);this.setRelated(i),e.each(this.getReverseRelations(),function(e){e.addRelated(this.instance,t)},this)},findRelated:function(t){var i=null;if(t=e.defaults({parse:this.options.parse},t),this.keyContents instanceof this.relatedModel)i=this.keyContents;else if(this.keyContents||0===this.keyContents){var n=e.defaults({create:this.options.createModels},t);i=this.relatedModel.findOrCreate(this.keyContents,n)}return this.related&&(this.keyId=null),i},setKeyContents:function(t){this.keyContents=t,this.keyId=i.Relational.store.resolveIdForItem(this.relatedModel,this.keyContents)},onChange:function(t,n,s){if(!this.isLocked()){this.acquire(),s=s?e.clone(s):{};var o=e.isUndefined(s.__related),r=o?this.related:s.__related;if(o){this.setKeyContents(n);var a=this.findRelated(s);this.setRelated(a)}if(r&&this.related!==r&&e.each(this.getReverseRelations(r),function(t){t.removeRelated(this.instance,null,s)},this),e.each(this.getReverseRelations(),function(t){t.addRelated(this.instance,s)},this),!s.silent&&this.related!==r){var l=this;this.changed=!0,i.Relational.eventQueue.add(function(){l.instance.trigger("change:"+l.key,l.instance,l.related,s,!0),l.changed=!1})}this.release()}},tryAddRelated:function(t,e,i){!this.keyId&&0!==this.keyId||t.id!==this.keyId||(this.addRelated(t,i),this.keyId=null)},addRelated:function(t,i){var n=this;t.queue(function(){if(t!==n.related){var s=n.related||null;n.setRelated(t),n.onChange(n.instance,t,e.defaults({__related:s},i))}})},removeRelated:function(t,i,n){if(this.related&&t===this.related){var s=this.related||null;this.setRelated(null),this.onChange(this.instance,t,e.defaults({__related:s},n))}}}),i.HasMany=i.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:i.Collection,collectionKey:!0,collectionOptions:{}},initialize:function(t){if(this.listenTo(this.instance,"relational:change:"+this.key,this.onChange),this.collectionType=this.options.collectionType,e.isString(this.collectionType)&&(this.collectionType=i.Relational.store.getObjectByName(this.collectionType)),this.collectionType!==i.Collection&&!(this.collectionType.prototype instanceof i.Collection))throw new Error("`collectionType` must inherit from Backbone.Collection");var n=this.findRelated(t);this.setRelated(n)},_prepareCollection:function(t){if(this.related&&this.stopListening(this.related),!(t&&t instanceof i.Collection)){var n=e.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions;t=new this.collectionType(null,n)}if(t.model=this.relatedModel,this.options.collectionKey){var s=this.options.collectionKey===!0?this.options.reverseRelation.key:this.options.collectionKey;t[s]&&t[s]!==this.instance?i.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,s,this.options.collectionKey):s&&(t[s]=this.instance)}return this.listenTo(t,"relational:add",this.handleAddition).listenTo(t,"relational:remove",this.handleRemoval).listenTo(t,"relational:reset",this.handleReset),t},findRelated:function(t){var n=null;if(t=e.defaults({parse:this.options.parse},t),this.keyContents instanceof i.Collection)this._prepareCollection(this.keyContents),n=this.keyContents;else{var s=[];e.each(this.keyContents,function(i){if(i instanceof this.relatedModel)var n=i;else n=this.relatedModel.findOrCreate(i,e.extend({merge:!0},t,{create:this.options.createModels}));n&&s.push(n)},this),n=this.related instanceof i.Collection?this.related:this._prepareCollection(),n.set(s,e.defaults({merge:!1,parse:!1},t))}return this.keyIds=e.difference(this.keyIds,e.pluck(n.models,"id")),n},setKeyContents:function(t){this.keyContents=t instanceof i.Collection?t:null,this.keyIds=[],this.keyContents||!t&&0!==t||(this.keyContents=e.isArray(t)?t:[t],e.each(this.keyContents,function(t){var e=i.Relational.store.resolveIdForItem(this.relatedModel,t);(e||0===e)&&this.keyIds.push(e)},this))},onChange:function(t,n,s){s=s?e.clone(s):{},this.setKeyContents(n),this.changed=!1;var o=this.findRelated(s);if(this.setRelated(o),!s.silent){var r=this;i.Relational.eventQueue.add(function(){r.changed&&(r.instance.trigger("change:"+r.key,r.instance,r.related,s,!0),r.changed=!1)})}},handleAddition:function(t,n,s){s=s?e.clone(s):{},this.changed=!0,e.each(this.getReverseRelations(t),function(t){t.addRelated(this.instance,s)},this);var o=this;!s.silent&&i.Relational.eventQueue.add(function(){o.instance.trigger("add:"+o.key,t,o.related,s)})},handleRemoval:function(t,n,s){s=s?e.clone(s):{},this.changed=!0,e.each(this.getReverseRelations(t),function(t){t.removeRelated(this.instance,null,s)},this);var o=this;!s.silent&&i.Relational.eventQueue.add(function(){o.instance.trigger("remove:"+o.key,t,o.related,s)})},handleReset:function(t,n){var s=this;n=n?e.clone(n):{},!n.silent&&i.Relational.eventQueue.add(function(){s.instance.trigger("reset:"+s.key,s.related,n)})},tryAddRelated:function(t,i,n){var s=e.contains(this.keyIds,t.id);s&&(this.addRelated(t,n),this.keyIds=e.without(this.keyIds,t.id))},addRelated:function(t,i){var n=this;t.queue(function(){n.related&&!n.related.get(t)&&n.related.add(t,e.defaults({parse:!1},i))})},removeRelated:function(t,e,i){this.related.get(t)&&this.related.remove(t,i)}}),i.RelationalModel=i.Model.extend({relations:null,_relations:null,_isInitialized:!1,_deferProcessing:!1,_queue:null,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(t,n){if(n&&n.collection){var s=this,o=this.collection=n.collection;delete n.collection,this._deferProcessing=!0;var r=function(t){t===s&&(s._deferProcessing=!1,s.processQueue(),o.off("relational:add",r))};o.on("relational:add",r),e.defer(function(){r(s)})}i.Relational.store.processOrphanRelations(),this._queue=new i.BlockingQueue,this._queue.block(),i.Relational.eventQueue.block();try{i.Model.apply(this,arguments)}finally{i.Relational.eventQueue.unblock()}},trigger:function(t){if(t.length>5&&0===t.indexOf("change")){var e=this,n=arguments;i.Relational.eventQueue.add(function(){if(e._isInitialized){var s=!0;if("change"===t)s=e.hasChanged();else{var o=t.slice(7),r=e.getRelation(o);r&&(s=n[4]===!0,s?e.changed[o]=n[2]:r.changed||delete e.changed[o])}s&&i.Model.prototype.trigger.apply(e,n)}})}else i.Model.prototype.trigger.apply(this,arguments);return this},initializeRelations:function(t){this.acquire(),this._relations={},e.each(this.relations||[],function(e){i.Relational.store.initializeRelation(this,e,t)},this),this._isInitialized=!0,this.release(),this.processQueue()},updateRelations:function(t){this._isInitialized&&!this.isLocked()&&e.each(this._relations,function(e){var i=this.attributes[e.keySource]||this.attributes[e.key];e.related!==i&&this.trigger("relational:change:"+e.key,this,i,t||{})},this)},queue:function(t){this._queue.add(t)},processQueue:function(){this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()&&this._queue.unblock()},getRelation:function(t){return this._relations[t]},getRelations:function(){return e.values(this._relations)},fetchRelated:function(t,n,s){n=e.extend({update:!0,remove:!1},n);var o,r=[],a=this.getRelation(t),l=a&&(a.keyIds||(a.keyId||0===a.keyId?[a.keyId]:[]));if(s){var c=a.related instanceof i.Collection?a.related.models:[a.related];e.each(c,function(t){(t.id||0===t.id)&&l.push(t.id)})}if(l&&l.length){var h=[],c=e.map(l,function(t){var e=i.Relational.store.find(a.relatedModel,t);if(!e){var s={};s[a.relatedModel.prototype.idAttribute]=t,e=a.relatedModel.findOrCreate(s,n),h.push(e)}return e},this);if(a.related instanceof i.Collection&&e.isFunction(a.related.url)&&(o=a.related.url(c)),o&&o!==a.related.url()){var u=e.defaults({error:function(){var t=arguments;e.each(h,function(e){e.trigger("destroy",e,e.collection,n),n.error&&n.error.apply(e,t)})},url:o},n);r=[a.related.fetch(u)]}else r=e.map(c,function(t){var i=e.defaults({error:function(){e.contains(h,t)&&(t.trigger("destroy",t,t.collection,n),n.error&&n.error.apply(t,arguments))}},n);return t.fetch(i)},this)}return r},get:function(n){var s=i.Model.prototype.get.call(this,n);if(!this.dotNotation||-1===n.indexOf("."))return s;var o=n.split("."),r=e.reduce(o,function(t,e){if(!(t instanceof i.Model))throw new Error("Attribute must be an instanceof Backbone.Model. Is: "+t+", currentSplit: "+e);return i.Model.prototype.get.call(t,e)},this);if(s!==t&&r!==t)throw new Error("Ambiguous result for '"+n+"'. direct result: "+s+", dotNotation: "+r);return s||r},set:function(t,n,s){i.Relational.eventQueue.block();var o;e.isObject(t)||null==t?(o=t,s=n):(o={},o[t]=n);try{var r=this.id,a=o&&this.idAttribute in o&&o[this.idAttribute];i.Relational.store.checkId(this,a);var l=i.Model.prototype.set.apply(this,arguments);this._isInitialized||this.isLocked()?a&&a!==r&&i.Relational.store.update(this):(this.constructor.initializeModelHierarchy(),i.Relational.store.register(this),this.initializeRelations(s)),o&&this.updateRelations(s)}finally{i.Relational.eventQueue.unblock()}return l},unset:function(t,e){i.Relational.eventQueue.block();var n=i.Model.prototype.unset.apply(this,arguments);return this.updateRelations(e),i.Relational.eventQueue.unblock(),n},clear:function(t){i.Relational.eventQueue.block();var e=i.Model.prototype.clear.apply(this,arguments);return this.updateRelations(t),i.Relational.eventQueue.unblock(),e},clone:function(){var t=e.clone(this.attributes);return e.isUndefined(t[this.idAttribute])||(t[this.idAttribute]=null),e.each(this.getRelations(),function(e){delete t[e.key]}),new this.constructor(t)},toJSON:function(t){if(this.isLocked())return this.id;this.acquire();var n=i.Model.prototype.toJSON.call(this,t);return!this.constructor._superModel||this.constructor._subModelTypeAttribute in n||(n[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue),e.each(this._relations,function(s){var o=n[s.key],r=s.options.includeInJSON,a=null;r===!0?o&&e.isFunction(o.toJSON)&&(a=o.toJSON(t)):e.isString(r)?(o instanceof i.Collection?a=o.pluck(r):o instanceof i.Model&&(a=o.get(r)),r===s.relatedModel.prototype.idAttribute&&(s instanceof i.HasMany?a=a.concat(s.keyIds):s instanceof i.HasOne&&(a=a||s.keyId))):e.isArray(r)?o instanceof i.Collection?(a=[],o.each(function(t){var i={};e.each(r,function(e){i[e]=t.get(e)}),a.push(i)})):o instanceof i.Model&&(a={},e.each(r,function(t){a[t]=o.get(t)})):delete n[s.key],r&&(n[s.keyDestination]=a),s.keyDestination!==s.key&&delete n[s.key]}),this.release(),n}},{setup:function(){return this.prototype.relations=(this.prototype.relations||[]).slice(0),this._subModels={},this._superModel=null,this.prototype.hasOwnProperty("subModelTypes")?i.Relational.store.addSubModels(this.prototype.subModelTypes,this):this.prototype.subModelTypes=null,e.each(this.prototype.relations||[],function(t){if(t.model||(t.model=this),t.reverseRelation&&t.model===this){var n=!0;if(e.isString(t.relatedModel)){var s=i.Relational.store.getObjectByName(t.relatedModel);n=s&&s.prototype instanceof i.RelationalModel}n?i.Relational.store.initializeRelation(null,t):e.isString(t.relatedModel)&&i.Relational.store.addOrphanRelation(t)}},this),this},build:function(t,e){var i=this;if(this.initializeModelHierarchy(),this._subModels&&this.prototype.subModelTypeAttribute in t){var n=t[this.prototype.subModelTypeAttribute],s=this._subModels[n];s&&(i=s)}return new i(t,e)},initializeModelHierarchy:function(){if(e.isUndefined(this._superModel)||e.isNull(this._superModel))if(i.Relational.store.setupSuperModel(this),this._superModel&&this._superModel.prototype.relations){var t=e.select(this._superModel.prototype.relations||[],function(t){return!e.any(this.prototype.relations||[],function(e){return t.relatedModel===e.relatedModel&&t.key===e.key},this)},this);this.prototype.relations=t.concat(this.prototype.relations)}else this._superModel=!1;this.prototype.subModelTypes&&e.keys(this.prototype.subModelTypes).length!==e.keys(this._subModels).length&&e.each(this.prototype.subModelTypes||[],function(t){var e=i.Relational.store.getObjectByName(t);e&&e.initializeModelHierarchy()})},findOrCreate:function(t,n){n||(n={});var s=e.isObject(t)&&n.parse&&this.prototype.parse?this.prototype.parse(t):t,o=i.Relational.store.find(this,s);return e.isObject(t)&&(o&&n.merge!==!1?(delete n.collection,o.set(s,n)):o||n.create===!1||(o=this.build(t,n))),o}}),e.extend(i.RelationalModel.prototype,i.Semaphore),i.Collection.prototype.__prepareModel=i.Collection.prototype._prepareModel,i.Collection.prototype._prepareModel=function(t,e){var n;return t instanceof i.Model?(t.collection||(t.collection=this),n=t):(e||(e={}),e.collection=this,n="undefined"!=typeof this.model.findOrCreate?this.model.findOrCreate(t,e):new this.model(t,e),n&&n.isNew()&&!n._validate(t,e)&&(this.trigger("invalid",this,t,e),n=!1)),n};var s=i.Collection.prototype.__set=i.Collection.prototype.set;i.Collection.prototype.set=function(t,n){if(!(this.model.prototype instanceof i.RelationalModel))return s.apply(this,arguments);n&&n.parse&&(t=this.parse(t,n)),e.isArray(t)||(t=t?[t]:[]);var o=[],r=[];return e.each(t,function(t){t instanceof i.Model||(t=i.Collection.prototype._prepareModel.call(this,t,n)),t&&(r.push(t),this.get(t)||this.get(t.cid)?null!=t.id&&(this._byId[t.id]=t):o.push(t))},this),s.call(this,r,e.defaults({parse:!1},n)),e.each(o,function(t){(this.get(t)||this.get(t.cid))&&this.trigger("relational:add",t,this,n)},this),this};var o=i.Collection.prototype.__remove=i.Collection.prototype.remove;i.Collection.prototype.remove=function(t,n){if(!(this.model.prototype instanceof i.RelationalModel))return o.apply(this,arguments);t=e.isArray(t)?t.slice():[t],n||(n={});var s=[];return e.each(t,function(t){t=this.get(t)||this.get(t.cid),t&&s.push(t)},this),s.length&&(o.call(this,s,n),e.each(s,function(t){this.trigger("relational:remove",t,this,n)},this)),this};var r=i.Collection.prototype.__reset=i.Collection.prototype.reset;i.Collection.prototype.reset=function(t,n){return n=e.extend({merge:!0},n),r.call(this,t,n),this.model.prototype instanceof i.RelationalModel&&this.trigger("relational:reset",this,n),this};var a=i.Collection.prototype.__sort=i.Collection.prototype.sort;i.Collection.prototype.sort=function(t){return a.call(this,t),this.model.prototype instanceof i.RelationalModel&&this.trigger("relational:reset",this,t),this};var l=i.Collection.prototype.__trigger=i.Collection.prototype.trigger;i.Collection.prototype.trigger=function(t){if(!(this.model.prototype instanceof i.RelationalModel))return l.apply(this,arguments);if("add"===t||"remove"===t||"reset"===t){var n=this,s=arguments;e.isObject(s[3])&&(s=e.toArray(s),s[3]=e.clone(s[3])),i.Relational.eventQueue.add(function(){l.apply(n,s)})}else l.apply(this,arguments);return this},i.RelationalModel.extend=function(){var t=i.Model.extend.apply(this,arguments);return t.setup(this),t}}();var app=app||{models:{},views:{},collections:{}};app.models.EventTile=Backbone.Model.extend({urlRoot:"/events"},{modelType:"Event"}),app.models.RestTile=Backbone.Model.extend({urlRoot:"/restaurants"},{modelType:"Restaurant"}),app.models.Stack=Backbone.Model.extend({urlRoot:function(){var t="/users/"+window.currentUser.id+"/stacks";return t}}),app.models.Stacktile=Backbone.Model.extend({url:function(){var t="/users/"+window.currentUser.id+"/stacks";return t}}),app.models.Tileable=Backbone.Model.extend({urlRoot:"/tiles",model:app.models.RestTile}),app.models.User=Backbone.Model.extend({initialize:function(){},url:function(){return"/users/"+this.id}}),app.collections.Stacktiles=Backbone.Collection.extend({model:app.models.Tileable}),app.collections.EventTileList=Backbone.Collection.extend({model:app.models.EventTile}),app.collections.RestTileList=Backbone.Collection.extend({model:app.models.RestTile}),app.collections.RestTileListSearch=Backbone.Collection.extend({model:app.models.RestTile}),app.collections.StackList=Backbone.Collection.extend({comparator:function(t){return t.get("id")},url:function(){var t="/users/"+window.currentUser.id+"/stacks";return t},model:app.models.Stack}),function(){this.JST||(this.JST={}),this.JST["templates/createstack"]=function(obj){var __p=[];with(obj||{})__p.push('<div class="box-header">\n  <div class="title">\n<h4>',this.model.stack_list.last().attributes.name,'</h4>\n  </div>\n  <div class="avatar" style="float:right;">\n  <img class="avatar-small" src="',this.model.attributes.image_url_small,'">\n</div>\n</div>\n\n<div id="stackresults" class="box-content padded">\n\n</div>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/event_tile"]=function(obj){var __p=[];with(obj||{})__p.push('\n<div id="resttilebox" data-id="',this.model.cid,'" >\n  <img id="tile" src="',this.model.attributes.image_url,'"></img>\n   <div id="tileoverlay">\n    ',this.model.attributes.name,"\n    </div>\n    ",date,'\n</div>\n\n<!--     <span id="tilename">\n    </span> -->\n\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/rest_tile"]=function(obj){var __p=[];with(obj||{})__p.push('\n\n\n<div id="resttilebox" data-id="',this.model.id,'" >\n  <img id="tile" src="',this.model.attributes.image_url,'"></img>\n  <div id="tileoverlay">\n    ',this.model.attributes.name,'\n  </div>\n\n<div class="yelpstars">\n  <img src="',this.model.attributes.yelp_stars_url,'"></img>\n<div>\n  </div>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/stacktile"]=function(obj){var __p=[];with(obj||{})__p.push('\n<div id="stacktilebox" data-id="',this.model.tileable.tiletype,'" >\n  <img src="',this.model.tileable.image_url,'"></img>\n\n  <div id="stackoverlay">\n    <div class="stacktilename">\n    ',this.model.tileable.name,'\n  </div>\n    <div class="stackyelpstars">\n      <img src="',this.model.tileable.yelp_stars_url,'"></img>\n    </div>\n  </div>\n   ',startdate,"\n   ",enddate,"\n\n</div>\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/start"]=function(obj){var __p=[];with(obj||{})__p.push('<div class="row-fluid">\n\n  <div id="googlemap">\n    <div id="map-canvas">\n\n    </div>\n  </div>\n</div>\n\n\n<div class="container-fluid padded">\n\n<div class="row-fluid">\n  <div id="searchlayer" class="span4">\n    <h3>Search an area</h3>\n\n    <input id="datepicker" class="datepicker fill-up" type="text" placeholder="Date"/>\n  \n        <div id="searchbox" class="input-prepend">\n      <a class="add-on" href="#">\n        <i class="icon-search"></i>\n      </a>\n    <input type=\'text\' id=\'areasearch\' placeholder=\'Enter a location\'/>\n    \n    </div>\n    <button id="showall" class="btn btn-large btn-gray">All</button>\n    <button id="restaurantfilter" class="btn btn-large btn-red">Restaurants</button>\n    <button id="barfilter" class="btn btn-large btn-green">Bars</button>\n    <button id="dancefilter" class="btn btn-large btn-black">Nightlife</button>\n    <button id="concertfilter" class="btn btn-large btn-facebook">Concerts</button>\n  </div>\n</div>\n\n\n<div id="bottomarea" class="row-fluid">\n\n\n  <div id="scrollbox" class="span7">\n  <div id="searchresults" class="span12 fly-simplified">\n\n  <div class="waiting">\n  </div>\n  </div>\n  </div>\n\n\n  <div id="calendarbox" class="box span5">\n    <div class="box-header">\n      <div id="stacknamebox">\n        <input type=\'text\' id=\'stackname\' placeholder=\'Name Your Event!\' style="float:left;"/>\n      </div>\n      <button id="stackbutton" class="btn btn-large btn-facebook">Create Stack</button>\n    </div>\n\n    <div class="box-content">\n      <div id="calendar" class="fc">\n      </div>\n    </div>\n\n  </div>\n\n\n');return __p.join("")}}.call(this),app.views.CreateStack=Backbone.View.extend({tagName:"div",className:"box",id:"createstack",template:JST["templates/createstack"],events:{"click #testbutton":"testFunction"},initialize:function(){$("#searchresults").isotope("destroy");var t=this;t.model.stack_list.fetch({wait:!0,success:function(t){t.last().attributes.tiles.forEach(function(t){var e=new app.views.StackTileView({model:t,id:t.tileable.tiletype});$("#stackresults").append(e.render().el).fadeIn(300)})}})},render:function(){var t=this.template();return this.$el.html(t),this},testFunction:function(){}}),app.views.EventTileView=Backbone.View.extend({tagName:"div",className:"event_tile",template:JST["templates/event_tile"],render:function(){var t=$.fullCalendar.parseDate(this.model.attributes.event_datetime),e=$.fullCalendar.formatDate(t,"h:mmtt");this.$el.html(this.template({model:this.model,date:e}));var i={title:this.model.attributes.name,start:this.model.attributes.event_datetime,type:this.model.constructor.modelType};return this.$el.data("eventObject",i),this}}),app.views.RestTileView=Backbone.View.extend({tagName:"div",className:"rest_tile",template:JST["templates/rest_tile"],render:function(){this.$el.html(this.template({model:this.model}));var t={title:this.model.attributes.name,type:this.model.constructor.modelType};return this.$el.data("eventObject",t),this}}),app.views.StackTileView=Backbone.View.extend({tagName:"div",className:"stacktile",template:JST["templates/stacktile"],render:function(){var t=$.fullCalendar.parseDate(this.model.start),e=$.fullCalendar.formatDate(t,"h:mmtt"),i=$.fullCalendar.parseDate(this.model.end),n=$.fullCalendar.formatDate(i,"h:mmtt");return this.$el.html(this.template({model:this.model,startdate:e,enddate:n})),this}});var restlatlng=[],barlatlng=[],dancelatlng=[],concertlatlng=[];app.views.StartView=Backbone.View.extend({tagName:"div",id:"start",template:JST["templates/start"],events:{"change #areasearch":"areaSearch","change #datepicker":"datePicker","click #resttilebox":"favoriteList","click #restaurantfilter":"restaurantFilter","click #barfilter":"barFilter","click #dancefilter":"danceFilter","click #concertfilter":"concertFilter","click #showall":"showAll","click #stackbutton":"sendCalendar"},initialize:function(){this.listenTo(this.model.RestTileList,"add",this.update)},render:function(){var t=this.template();return this.$el.html(t),this},datePicker:function(){var t=$(".datepicker").val(),e=new Date(t);$("#calendar").fullCalendar("gotoDate",e)},areaSearch:function(){deleteOverlays(),restlatlng=[],barlatlng=[],dancelatlng=[],concertlatlng=[],latlng=[];var t=$(event.target).val(),e=$(".datepicker").val(),i=this;$(".waiting").toggle(),$("#searchresults").html(""),$("#searchresults").isotope("destroy"),$.ajax({url:"/restaurant_tiles",type:"POST",data:{searchterm:t},success:function(t){i.model.rest_tile_search.reset(),i.model.rest_tile_search.add(t),i.model.rest_tile_totalsearch.add(t);var e=[];i.model.rest_tile_search.models.forEach(function(t){addMarker(t.attributes.latitude,t.attributes.longitude,t.attributes.name,t.attributes.tiletype,t.attributes.name);var n=new app.views.RestTileView({model:t,id:t.attributes.yelp_url});switch(t.attributes.tiletype){case"Restaurants":i.$el.find("#searchresults").append(n.render().el);var s=new google.maps.LatLng(t.attributes.latitude,t.attributes.longitude);e.push(s),restlatlng.push(s);break;case"Bars":i.$el.find("#searchresults").append(n.render().$el.removeClass("rest_tile").addClass("bar_tile"));var o=new google.maps.LatLng(t.attributes.latitude,t.attributes.longitude);e.push(o),barlatlng.push(o);break;case"DanceClubs":i.$el.find("#searchresults").append(n.render().$el.removeClass("rest_tile").addClass("dance_tile"));var r=new google.maps.LatLng(t.attributes.latitude,t.attributes.longitude);e.push(r),dancelatlng.push(r)}}),zoomin(e),e=[],$(".rest_tile, .bar_tile, .dance_tile").draggable({revert:"true",revertDuration:0,cursor:"move",containment:"document",helper:"clone",cursor:"move",helper:function(){return $(this).clone().removeAttr("style").removeClass("isotope-item").addClass("drag-helper").appendTo("body")},start:function(){},stop:function(){$(this).show()},zIndex:100})}}),$.ajax({url:"/event_tiles",type:"POST",data:{searchterm:t,searchdate:e},success:function(t){var n=[];i.model.event_tile_search.reset(),i.model.event_tile_search.add(t),i.model.event_tile_totalsearch.add(t),i.model.event_tile_search.models.forEach(function(t){addMarker(t.attributes.latitude,t.attributes.longitude,t.attributes.name,"concert",t.attributes.name);var e=new app.views.EventTileView({model:t,id:t.attributes.event_url});i.$el.find("#searchresults").append(e.render().el);var s=new google.maps.LatLng(t.attributes.latitude,t.attributes.longitude);n.push(s),concertlatlng.push(s)}),$(".event_tile").draggable({revert:"true",revertDuration:0,cursor:"move",containment:"document",helper:"clone",cursor:"move",helper:function(){return $(this).clone().removeAttr("style").removeClass("isotope-item").addClass("drag-helper").appendTo("body")},start:function(){},stop:function(){$(this).show()},zIndex:100}),$("#searchresults").isotope({layoutMode:"fitRows"});var s=new Date(e);$("#calendar").fullCalendar("gotoDate",s)}})},favoriteList:function(t){t.preventDefault();var e=$(t.currentTarget).data("id"),i=this.model.rest_tile_search.get(e);this.model.RestTileList.create(i)},restaurantFilter:function(){$("#searchresults").isotope({filter:".rest_tile"}),zoomin(restlatlng)},barFilter:function(){$("#searchresults").isotope({filter:".bar_tile"}),zoomin(barlatlng)},danceFilter:function(){$("#searchresults").isotope({filter:".dance_tile"}),zoomin(dancelatlng)},concertFilter:function(){$("#searchresults").isotope({filter:".event_tile"}),zoomin(concertlatlng)},showAll:function(){$("#searchresults").isotope({filter:""}),zoomin(latlng)},sendCalendar:function(){var t=this,e=$("#calendar").fullCalendar("clientEvents");
console.log(e);var i=e.length,n=new app.models.Stack;n.attributes.name=$("#stackname").val(),n.attributes.stackday=new Date,n.newstacktiles=new app.collections.Stacktiles,t.model.stack_list.create(n,{wait:!0,success:function(n){var s=n;e.forEach(function(e){switch(e.type){case"Restaurant":var n=t.model.rest_tile_totalsearch.findWhere({yelp_url:e.cid});n.save(null,{success:function(n){var o=new app.models.Tileable;o.attributes.name=e.title,o.attributes.tileable_id=n.id,o.attributes.tileable_type=e.type,o.attributes.end=e.end,o.attributes.start=e.start,o.attributes.allDay=e.allDay,o.attributes.stack_id=s.id,_.last(t.model.stack_list.models).newstacktiles.create(o,{wait:!0,success:function(){if(--i,0==i){var e=new app.views.CreateStack({model:t.model}).render();$("#searchresults").html(""),$("#searchresults").html(e.el)}}})}});break;case"Event":var n=t.model.event_tile_totalsearch.findWhere({event_url:e.cid});n.save(null,{success:function(n){var o=new app.models.Tileable;o.attributes.name=e.title,o.attributes.tileable_id=n.id,o.attributes.tileable_type=e.type,o.attributes.end=e.end,o.attributes.start=e.start,o.attributes.allDay=e.allDay,o.attributes.stack_id=s.id,_.last(t.model.stack_list.models).newstacktiles.create(o,{wait:!0,success:function(){if(--i,0==i){var e=new app.views.CreateStack({model:t.model}).render();$("#searchresults").html(""),$("#searchresults").html(e.el)}}})}})}})}})}});var map,markers=[],latlng=[];/*!
 * stroll.js 1.2 - CSS scroll effects
 * http://lab.hakim.se/scroll-effects
 * MIT licensed
 * 
 * Copyright (C) 2012 Hakim El Hattab, http://hakim.se
 */
!function(){"use strict";function t(){if(u){requestAnimFrame(t);for(var e=0,i=h.length;i>e;e++)h[e].update()}}function e(e,s){if(!e.nodeName||/^(ul|li)$/i.test(e.nodeName)===!1)return!1;n(e)&&i(e);var o=c?new a(e):new r(e);s&&s.live&&(o.syncInterval=setInterval(function(){o.sync.call(o)},l)),o.sync(),h.push(o),1===h.length&&(u=!0,t())}function i(t){for(var e=0;e<h.length;e++){var i=h[e];i.element==t&&(i.destroy(),h.splice(e,1),e--)}0===h.length&&(u=!1)}function n(t){for(var e=0,i=h.length;i>e;e++)if(h[e].element==t)return!0;return!1}function s(t,e,i){var n,s;if("string"==typeof t){var o=document.querySelectorAll(t);for(n=0,s=o.length;s>n;n++)e.call(null,o[n],i)}else if("object"==typeof t&&"number"==typeof t.length)for(n=0,s=t.length;s>n;n++)e.call(null,t[n],i);else{if(!t.nodeName)throw"Stroll target was of unexpected type.";e.call(null,t,i)}}function o(){return!!document.body.classList}function r(t){this.element=t}function a(t){this.element=t,this.element.style.overflow="hidden",this.top={value:0,natural:0},this.touch={value:0,offset:0,start:0,previous:0,lastMove:Date.now(),accellerateTimeout:-1,isAccellerating:!1,isActive:!1},this.velocity=0}var l=500,c=!!("ontouchstart"in window),h=[],u=!1;r.prototype.sync=function(){this.items=Array.prototype.slice.apply(this.element.children),this.listHeight=this.element.offsetHeight;for(var t=0,e=this.items.length;e>t;t++){var i=this.items[t];i._offsetHeight=i.offsetHeight,i._offsetTop=i.offsetTop,i._offsetBottom=i._offsetTop+i._offsetHeight,i._state=""}this.update(!0)},r.prototype.update=function(t){var e=this.element.pageYOffset||this.element.scrollTop,i=e+this.listHeight;if(e!==this.lastTop||t){this.lastTop=e;for(var n=0,s=this.items.length;s>n;n++){var o=this.items[n];o._offsetBottom<e?"past"!==o._state&&(o._state="past",o.classList.add("past"),o.classList.remove("future")):o._offsetTop>i?"future"!==o._state&&(o._state="future",o.classList.add("future"),o.classList.remove("past")):o._state&&("past"===o._state&&o.classList.remove("past"),"future"===o._state&&o.classList.remove("future"),o._state="")}}},r.prototype.destroy=function(){clearInterval(this.syncInterval);for(var t=0,e=this.items.length;e>t;t++){var i=this.items[t];i.classList.remove("past"),i.classList.remove("future")}},a.prototype=new r,a.prototype.sync=function(){this.items=Array.prototype.slice.apply(this.element.children),this.listHeight=this.element.offsetHeight;for(var t,e=0,i=this.items.length;i>e;e++)t=this.items[e],t._offsetHeight=t.offsetHeight,t._offsetTop=t.offsetTop,t._offsetBottom=t._offsetTop+t._offsetHeight,t._state="",t.style.opacity=1;this.top.natural=this.element.scrollTop,this.top.value=this.top.natural,this.top.max=t._offsetBottom-this.listHeight,this.update(!0),this.bind()},a.prototype.bind=function(){var t=this;this.touchStartDelegate=function(e){t.onTouchStart(e)},this.touchMoveDelegate=function(e){t.onTouchMove(e)},this.touchEndDelegate=function(e){t.onTouchEnd(e)},this.element.addEventListener("touchstart",this.touchStartDelegate,!1),this.element.addEventListener("touchmove",this.touchMoveDelegate,!1),this.element.addEventListener("touchend",this.touchEndDelegate,!1)},a.prototype.onTouchStart=function(t){if(t.preventDefault(),1===t.touches.length)if(this.touch.isActive=!0,this.touch.start=t.touches[0].clientY,this.touch.previous=this.touch.start,this.touch.value=this.touch.start,this.touch.offset=0,this.velocity){this.touch.isAccellerating=!0;var e=this;this.touch.accellerateTimeout=setTimeout(function(){e.touch.isAccellerating=!1,e.velocity=0},500)}else this.velocity=0},a.prototype.onTouchMove=function(t){if(1===t.touches.length){var e=this.touch.value;this.touch.value=t.touches[0].clientY,this.touch.lastMove=Date.now();var i=this.touch.value>this.touch.previous&&this.velocity<0||this.touch.value<this.touch.previous&&this.velocity>0;this.touch.isAccellerating&&i?(clearInterval(this.touch.accellerateTimeout),this.velocity+=(this.touch.previous-this.touch.value)/10):(this.velocity=0,this.touch.isAccellerating=!1,this.touch.offset=Math.round(this.touch.start-this.touch.value)),this.touch.previous=e}},a.prototype.onTouchEnd=function(t){var e=this.touch.start-this.touch.value;this.touch.isAccellerating||(this.velocity=(this.touch.start-this.touch.value)/10),(Date.now()-this.touch.lastMove>200||Math.abs(this.touch.previous-this.touch.value)<5)&&(this.velocity=0),this.top.value+=this.touch.offset,this.touch.offset=0,this.touch.start=0,this.touch.value=0,this.touch.isActive=!1,this.touch.isAccellerating=!1,clearInterval(this.touch.accellerateTimeout),(Math.abs(this.velocity)>4||Math.abs(e)>10)&&t.preventDefault()},a.prototype.update=function(t){var e=this.top.value+this.velocity+this.touch.offset;if((this.velocity||this.touch.offset)&&(this.element.scrollTop=e,e=Math.max(0,Math.min(this.element.scrollTop,this.top.max)),this.top.value=e-this.touch.offset),(!this.touch.isActive||this.touch.isAccellerating)&&(this.velocity*=.95),Math.abs(this.velocity)<.15&&(this.velocity=0),e!==this.top.natural||t){this.top.natural=e,this.top.value=e-this.touch.offset;for(var i=e+this.listHeight,n=0,s=this.items.length;s>n;n++){var o=this.items[n];o._offsetBottom<e?this.velocity<=0&&"past"!==o._state&&(o.classList.add("past"),o._state="past"):o._offsetTop>i?this.velocity>=0&&"future"!==o._state&&(o.classList.add("future"),o._state="future"):o._state&&("past"===o._state&&o.classList.remove("past"),"future"===o._state&&o.classList.remove("future"),o._state="")}}},a.prototype.destroy=function(){r.prototype.destroy.apply(this),this.element.removeEventListener("touchstart",this.touchStartDelegate,!1),this.element.removeEventListener("touchmove",this.touchMoveDelegate,!1),this.element.removeEventListener("touchend",this.touchEndDelegate,!1)},window.stroll={bind:function(t,i){o()&&s(t,e,i)},unbind:function(t){o()&&s(t,i)}},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}()}(),app.Router=Backbone.Router.extend({routes:{"":"home","_=_":"home",userstacks:"userstacks"},home:function(){var t=new app.models.User;t.url="users/me",t.fetch({success:function(e){t.id=e.id,t.RestTileList=new app.collections.RestTileList,t.RestTileList.url="/tiles",t.RestTileList.on("reset",this.updateCounts),t.rest_tile_search=new app.collections.RestTileList,t.event_tile_search=new app.collections.EventTileList,t.rest_tile_totalsearch=new app.collections.RestTileList,t.event_tile_totalsearch=new app.collections.EventTileList,t.stack_list=new app.collections.StackList,t.RestTileList.fetch({success:function(){var e=new app.views.StartView({model:t});$("#content").html(e.render().el),initMap(),$(".datepicker").datepicker();var i=new Date,n=i.getMonth()+1+"/"+i.getDate()+"/"+i.getFullYear();$(".datepicker").val(n),map.panBy(-200,0),$("#calendar").fullCalendar({header:{left:"prev,next today",center:"title",right:"agendaDay, agendaWeek",ignoreTimezone:!1},defaultView:"agendaDay",firstDay:5,firstHour:18,selectable:!0,selectHelper:!0,editable:!0,droppable:!0,height:440,drop:function(e,i){t.rest_tile_search.get(this.id);var n=$(this).data("eventObject"),s=$.extend({},n);if(void 0==s.start)s.start=e,s.end=(e.getTime()+72e5)/1e3;else{s.start=s.start+"Z";var o=$.fullCalendar.parseDate(s.start);s.start=o,s.end=(o.getTime()+72e5)/1e3}s.allDay=i,s.cid=this.id,$("#calendar").fullCalendar("renderEvent",s,!0)}})}})}})},userstacks:function(){}}),$(document).ready(function(){$.ajaxSetup({headers:{"X-CSRF-Token":$('meta[name="csrf-token"]').attr("content")}});var t=new app.Router;Backbone.history.start({pushState:!1}),t.navigate("")});